name: Update Existing Key in Config

on:
  issue_comment:
    types: [created]

jobs:
  update-config:
    runs-on: ubuntu-latest
    if: startsWith(github.event.comment.body, '/update-config')
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Extract User Input from Comment
        id: extract
        run: |
          COMMENT_BODY="${{ github.event.comment.body }}"
          KEY=$(echo "$COMMENT_BODY" | awk '{print $2}')
          VALUE=$(echo "$COMMENT_BODY" | awk '{$1=$2=""; print substr($0,3)}')

          echo "Updating key: $KEY"
          echo "New value: $VALUE"

          echo "KEY=$KEY" >> $GITHUB_ENV
          echo "VALUE=$VALUE" >> $GITHUB_ENV

      - name: Check if Key Exists in config.json
        id: check_key
        run: |
          if jq -e 'has(env.KEY)' config.json > /dev/null; then
            echo "Key exists. Proceeding with update."
            echo "EXISTS=true" >> $GITHUB_ENV
          else
            echo "Key does not exist!"
            echo "EXISTS=false" >> $GITHUB_ENV
          fi

      - name: Update config.json if Key Exists
        if: env.EXISTS == 'true'
        run: |
          jq --arg key "$KEY" --arg value "$VALUE" 'if has($key) then .[$key] = $value else . end' config.json > temp.json && mv temp.json config.json

      - name: Commit and Push Changes
        if: env.EXISTS == 'true'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add config.json
          git commit -m "Updated $KEY in config.json"
          git push origin main

      - name: Comment on Issue (Success)
        if: env.EXISTS == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUMBER=${{ github.event.issue.number }}
          curl -X POST -H "Authorization: Bearer $GITHUB_TOKEN" \
          -H "Accept: application/vnd.github.v3+json" \
          https://api.github.com/repos/${{ github.repository }}/issues/$ISSUE_NUMBER/comments \
          -d '{"body":"✅ The `config.json` file has been updated! Key: **'$KEY'** → Value: **'$VALUE'**"}'

      - name: Comment on Issue (Key Not Found)
        if: env.EXISTS == 'false'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUMBER=${{ github.event.issue.number }}
          curl -X POST -H "Authorization: Bearer $GITHUB_TOKEN" \
          -H "Accept: application/vnd.github.v3+json" \
          https://api.github.com/repos/${{ github.repository }}/issues/$ISSUE_NUMBER/comments \
          -d '{"body":"❌ The key **'$KEY'** does not exist in `config.json`. No changes were made."}'
